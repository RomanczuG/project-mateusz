[
  {
    "url": "https://api.github.com/repos/expressjs/express/issues/comments/315074644",
    "html_url": "https://github.com/expressjs/express/issues/3365#issuecomment-315074644",
    "issue_url": "https://api.github.com/repos/expressjs/express/issues/3365",
    "id": 315074644,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTA3NDY0NA==",
    "user": {
      "login": "dougwilson",
      "id": 67512,
      "node_id": "MDQ6VXNlcjY3NTEy",
      "avatar_url": "https://avatars.githubusercontent.com/u/67512?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dougwilson",
      "html_url": "https://github.com/dougwilson",
      "followers_url": "https://api.github.com/users/dougwilson/followers",
      "following_url": "https://api.github.com/users/dougwilson/following{/other_user}",
      "gists_url": "https://api.github.com/users/dougwilson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dougwilson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dougwilson/subscriptions",
      "organizations_url": "https://api.github.com/users/dougwilson/orgs",
      "repos_url": "https://api.github.com/users/dougwilson/repos",
      "events_url": "https://api.github.com/users/dougwilson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dougwilson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-13T13:16:48Z",
    "updated_at": "2017-07-13T13:16:48Z",
    "author_association": "MEMBER",
    "body": "I don't think adding that assertion is the correct solution; replying to a websocket in Express does work, and if you are getting an error, there much be something else going on. That original issue you linked to I asked for steps to reproduce, but never got any, so before we can really figure out why something that should work isn't (and then now just declaring it shouldn't work), let's try to figure out what is going wrong here (plus even if we added that, we'd need to add a test case).\r\n\r\nI can dig in, but need information to reproduce the issue. If you're not sure where to start, please provide the following:\r\n\r\n1. The exact version of Express\r\n2. The exact version of Node.js\r\n3. The exact versions of all other modules needs to reproduce.\r\n4. Full, complete source code we can copy and paste into a file and run.\r\n5. Full, complete instructions on how to reproduce. Please include as much information as possible, as everything you just leave to implied makes it that much more unlikely for us to reproduce.\r\n\r\nThanks!",
    "reactions": {
      "url": "https://api.github.com/repos/expressjs/express/issues/comments/315074644/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/expressjs/express/issues/comments/315076466",
    "html_url": "https://github.com/expressjs/express/issues/3365#issuecomment-315076466",
    "issue_url": "https://api.github.com/repos/expressjs/express/issues/3365",
    "id": 315076466,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTA3NjQ2Ng==",
    "user": {
      "login": "dougwilson",
      "id": 67512,
      "node_id": "MDQ6VXNlcjY3NTEy",
      "avatar_url": "https://avatars.githubusercontent.com/u/67512?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dougwilson",
      "html_url": "https://github.com/dougwilson",
      "followers_url": "https://api.github.com/users/dougwilson/followers",
      "following_url": "https://api.github.com/users/dougwilson/following{/other_user}",
      "gists_url": "https://api.github.com/users/dougwilson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dougwilson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dougwilson/subscriptions",
      "organizations_url": "https://api.github.com/users/dougwilson/orgs",
      "repos_url": "https://api.github.com/users/dougwilson/repos",
      "events_url": "https://api.github.com/users/dougwilson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dougwilson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-13T13:24:11Z",
    "updated_at": "2017-07-13T13:24:11Z",
    "author_association": "MEMBER",
    "body": "Also, since both issues have `express-session` in their stack, and it does weird things to the response object, it's possible this may be an issue with the `express-session` library. That is something I would like to validate once I get some code I can play with :)",
    "reactions": {
      "url": "https://api.github.com/repos/expressjs/express/issues/comments/315076466/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/expressjs/express/issues/comments/315087428",
    "html_url": "https://github.com/expressjs/express/issues/3365#issuecomment-315087428",
    "issue_url": "https://api.github.com/repos/expressjs/express/issues/3365",
    "id": 315087428,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTA4NzQyOA==",
    "user": {
      "login": "Vinno97",
      "id": 9059378,
      "node_id": "MDQ6VXNlcjkwNTkzNzg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9059378?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Vinno97",
      "html_url": "https://github.com/Vinno97",
      "followers_url": "https://api.github.com/users/Vinno97/followers",
      "following_url": "https://api.github.com/users/Vinno97/following{/other_user}",
      "gists_url": "https://api.github.com/users/Vinno97/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Vinno97/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Vinno97/subscriptions",
      "organizations_url": "https://api.github.com/users/Vinno97/orgs",
      "repos_url": "https://api.github.com/users/Vinno97/repos",
      "events_url": "https://api.github.com/users/Vinno97/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Vinno97/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-13T14:03:46Z",
    "updated_at": "2017-07-13T14:03:46Z",
    "author_association": "NONE",
    "body": "My apologies. \r\nAfter further investigation, the error does not occur without `express-session`. I was under the impression that it was caused by Node.JS throwing errors while making HTTP responses to WebSockets and that `express-session`  just happened to be the last module to touch the response.\r\nI thought that if it was a limitation by Node.JS, it might as well be prevented as early as possible.\r\n\r\nBut nonetheless:\r\n* Express 4.15.3\r\n* Node.JS v6.11.0\r\n* Modules needed to reproduce:\r\n  * `express-ws@3.0.0`\r\n  * `express-session@1.15.3`\r\n  * `express@4.15.3`\r\n* A simple test that causes the same error:\r\n```js\r\nlet express = require('express');\r\nlet expressWs = require('express-ws');\r\nlet session = require('express-session')\r\n\r\nlet app = express();\r\n\r\nexpressWs(app);\r\n\r\napp.use(session({\r\n    secret: 'sssh',\r\n    saveUninitialized: true,\r\n    resave: false\r\n}))\r\n\r\napp.use('*', (req, res) => {\r\n    res.send('Hello world!');\r\n});\r\n\r\napp.listen(3000);\r\n```\r\n\r\nTheres not that much more more to play with, but adding the following code might help with some debugging:\r\n```js\r\n/* This isn't needed */\r\napp.ws('/echo', function(ws, req) {\r\n  ws.on('message', function(msg) {\r\n    ws.send(msg);\r\n  });\r\n});\r\n```\r\n\r\n<br />\r\nAlso, you said:\r\n\r\n> replying to a websocket in Express does work\r\n\r\nI was not able to get a websocket to open without `expressWs(app);`. I assume that you meant express does not throw this error by itself when replying to a WebSocket?",
    "reactions": {
      "url": "https://api.github.com/repos/expressjs/express/issues/comments/315087428/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/expressjs/express/issues/comments/315088947",
    "html_url": "https://github.com/expressjs/express/issues/3365#issuecomment-315088947",
    "issue_url": "https://api.github.com/repos/expressjs/express/issues/3365",
    "id": 315088947,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTA4ODk0Nw==",
    "user": {
      "login": "dougwilson",
      "id": 67512,
      "node_id": "MDQ6VXNlcjY3NTEy",
      "avatar_url": "https://avatars.githubusercontent.com/u/67512?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dougwilson",
      "html_url": "https://github.com/dougwilson",
      "followers_url": "https://api.github.com/users/dougwilson/followers",
      "following_url": "https://api.github.com/users/dougwilson/following{/other_user}",
      "gists_url": "https://api.github.com/users/dougwilson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dougwilson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dougwilson/subscriptions",
      "organizations_url": "https://api.github.com/users/dougwilson/orgs",
      "repos_url": "https://api.github.com/users/dougwilson/repos",
      "events_url": "https://api.github.com/users/dougwilson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dougwilson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-13T14:09:06Z",
    "updated_at": "2017-07-13T14:09:06Z",
    "author_association": "MEMBER",
    "body": "Thanks so much for that information. I was hoping you were not going to say `express-ws`. This is a known issue for that module. The issue is that the module is incorrectly overwriting the Node.js core method `res.writeHead` here: https://github.com/HenningM/express-ws/blob/master/src/index.js#L60-L65\r\n\r\nThe problem is that Node.js core is expecting that the call to `res.writeHead` sets a string to `res._header`, but the `express-ws` module does not do that. It need to either perform the same functions has the `res.writeHead` it is replacing or monkey patch more methods in Node.js core to achieve whatever it is trying to achieve.\r\n\r\nI hope this helps narrow down what the cause is :) !",
    "reactions": {
      "url": "https://api.github.com/repos/expressjs/express/issues/comments/315088947/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/expressjs/express/issues/comments/315089328",
    "html_url": "https://github.com/expressjs/express/issues/3365#issuecomment-315089328",
    "issue_url": "https://api.github.com/repos/expressjs/express/issues/3365",
    "id": 315089328,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTA4OTMyOA==",
    "user": {
      "login": "dougwilson",
      "id": 67512,
      "node_id": "MDQ6VXNlcjY3NTEy",
      "avatar_url": "https://avatars.githubusercontent.com/u/67512?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dougwilson",
      "html_url": "https://github.com/dougwilson",
      "followers_url": "https://api.github.com/users/dougwilson/followers",
      "following_url": "https://api.github.com/users/dougwilson/following{/other_user}",
      "gists_url": "https://api.github.com/users/dougwilson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dougwilson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dougwilson/subscriptions",
      "organizations_url": "https://api.github.com/users/dougwilson/orgs",
      "repos_url": "https://api.github.com/users/dougwilson/repos",
      "events_url": "https://api.github.com/users/dougwilson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dougwilson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-13T14:10:27Z",
    "updated_at": "2017-07-13T14:10:27Z",
    "author_association": "MEMBER",
    "body": "Removing `express-session`, you should still be able to reproduce:\r\n```js\r\nlet express = require('express');\r\nlet expressWs = require('express-ws');\r\n\r\nlet app = express();\r\n\r\nexpressWs(app);\r\n\r\napp.use('*', (req, res) => {\r\n    res.write('Hello world!');\r\n    res.end();\r\n});\r\n\r\napp.listen(3000);\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/expressjs/express/issues/comments/315089328/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/expressjs/express/issues/comments/315090012",
    "html_url": "https://github.com/expressjs/express/issues/3365#issuecomment-315090012",
    "issue_url": "https://api.github.com/repos/expressjs/express/issues/3365",
    "id": 315090012,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTA5MDAxMg==",
    "user": {
      "login": "dougwilson",
      "id": 67512,
      "node_id": "MDQ6VXNlcjY3NTEy",
      "avatar_url": "https://avatars.githubusercontent.com/u/67512?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dougwilson",
      "html_url": "https://github.com/dougwilson",
      "followers_url": "https://api.github.com/users/dougwilson/followers",
      "following_url": "https://api.github.com/users/dougwilson/following{/other_user}",
      "gists_url": "https://api.github.com/users/dougwilson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dougwilson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dougwilson/subscriptions",
      "organizations_url": "https://api.github.com/users/dougwilson/orgs",
      "repos_url": "https://api.github.com/users/dougwilson/repos",
      "events_url": "https://api.github.com/users/dougwilson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dougwilson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-13T14:12:50Z",
    "updated_at": "2017-07-13T14:12:50Z",
    "author_association": "MEMBER",
    "body": "> I was not able to get a websocket to open without expressWs(app);. I assume that you meant express does not throw this error by itself when replying to a WebSocket?\r\n\r\nNo, I mean it does work. There are multiple methods to get a websocket request into Express, one of those being that `express-ws` module. If you have a proper response object that doesn't have a faulty patch applied to it it works just fine. A web browser getting a 404 to a websocket upgrade request is a valid thing to happen (of course it won't establish the websocket).\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/expressjs/express/issues/comments/315090012/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/expressjs/express/issues/comments/315091654",
    "html_url": "https://github.com/expressjs/express/issues/3365#issuecomment-315091654",
    "issue_url": "https://api.github.com/repos/expressjs/express/issues/3365",
    "id": 315091654,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTA5MTY1NA==",
    "user": {
      "login": "dougwilson",
      "id": 67512,
      "node_id": "MDQ6VXNlcjY3NTEy",
      "avatar_url": "https://avatars.githubusercontent.com/u/67512?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dougwilson",
      "html_url": "https://github.com/dougwilson",
      "followers_url": "https://api.github.com/users/dougwilson/followers",
      "following_url": "https://api.github.com/users/dougwilson/following{/other_user}",
      "gists_url": "https://api.github.com/users/dougwilson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dougwilson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dougwilson/subscriptions",
      "organizations_url": "https://api.github.com/users/dougwilson/orgs",
      "repos_url": "https://api.github.com/users/dougwilson/repos",
      "events_url": "https://api.github.com/users/dougwilson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dougwilson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-13T14:18:48Z",
    "updated_at": "2017-07-13T14:18:48Z",
    "author_association": "MEMBER",
    "body": "Thread about this issue on that module: https://github.com/HenningM/express-ws/issues/64 I'm going to add in the information I stated here on that thread.",
    "reactions": {
      "url": "https://api.github.com/repos/expressjs/express/issues/comments/315091654/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/expressjs/express/issues/comments/315107318",
    "html_url": "https://github.com/expressjs/express/issues/3365#issuecomment-315107318",
    "issue_url": "https://api.github.com/repos/expressjs/express/issues/3365",
    "id": 315107318,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTEwNzMxOA==",
    "user": {
      "login": "Vinno97",
      "id": 9059378,
      "node_id": "MDQ6VXNlcjkwNTkzNzg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/9059378?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Vinno97",
      "html_url": "https://github.com/Vinno97",
      "followers_url": "https://api.github.com/users/Vinno97/followers",
      "following_url": "https://api.github.com/users/Vinno97/following{/other_user}",
      "gists_url": "https://api.github.com/users/Vinno97/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Vinno97/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Vinno97/subscriptions",
      "organizations_url": "https://api.github.com/users/Vinno97/orgs",
      "repos_url": "https://api.github.com/users/Vinno97/repos",
      "events_url": "https://api.github.com/users/Vinno97/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Vinno97/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-13T15:09:27Z",
    "updated_at": "2017-08-03T07:22:52Z",
    "author_association": "NONE",
    "body": "Thank you very much for all your help and I hope the guys at `express-ws` are able to make a patch soon!\r\n\r\nLuckily, this problem only occurs in my project when an unhandled error occurs and I will probably just check for ```req.headers.upgrade === 'websocket'``` for the time being.\r\n\r\nAbout the \"replying to a websocket in Express does work\"-thing: I misinterpreted this and thought you meant express had native WebSocket support ;)\r\n\r\n**EDIT:** changed ```req.upgrade === 'websocket'``` to ```req.headers.upgrade === 'websocket'```.\r\n```req.upgrade``` is just a boolean and should not be used to check for websocket handshakes.",
    "reactions": {
      "url": "https://api.github.com/repos/expressjs/express/issues/comments/315107318/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/expressjs/express/issues/comments/315109282",
    "html_url": "https://github.com/expressjs/express/issues/3365#issuecomment-315109282",
    "issue_url": "https://api.github.com/repos/expressjs/express/issues/3365",
    "id": 315109282,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTEwOTI4Mg==",
    "user": {
      "login": "dougwilson",
      "id": 67512,
      "node_id": "MDQ6VXNlcjY3NTEy",
      "avatar_url": "https://avatars.githubusercontent.com/u/67512?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dougwilson",
      "html_url": "https://github.com/dougwilson",
      "followers_url": "https://api.github.com/users/dougwilson/followers",
      "following_url": "https://api.github.com/users/dougwilson/following{/other_user}",
      "gists_url": "https://api.github.com/users/dougwilson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dougwilson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dougwilson/subscriptions",
      "organizations_url": "https://api.github.com/users/dougwilson/orgs",
      "repos_url": "https://api.github.com/users/dougwilson/repos",
      "events_url": "https://api.github.com/users/dougwilson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dougwilson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-13T15:16:02Z",
    "updated_at": "2017-07-13T15:16:02Z",
    "author_association": "MEMBER",
    "body": "> About the \"replying to a websocket in Express does work\"-thing: I misinterpreted this and thought you meant express had native WebSocket support ;)\r\n\r\nAh, yes, it doesn't have _native_ support for getting the requests into the pipeline, but if they do get in there, they should work fine (which is why there are a bunch of modules doing this). Because of the abstraction that Express is (just a `function(req, res)` at it's heart) and that the Node.js HTTP server implementation choose to emit upgrade requests using a different event name, it means that there is some writing up that needs to happen between Express and the HTTP server that Node.js core doesn't do for us, thus requiring some more to do the wiring up.",
    "reactions": {
      "url": "https://api.github.com/repos/expressjs/express/issues/comments/315109282/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]